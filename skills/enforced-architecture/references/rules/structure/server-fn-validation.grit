// ─── structure/server-fn-validation ──────────────────────────────────────
//
// Tag:      structure
// Mechanism: GritQL (per-file, real-time)
// Blocking: Yes
//
// Prevents: Server functions that accept input without validation.
//           Every createServerFn that chains .handler() should first
//           chain .validator() (or .inputValidator()) to ensure input
//           is validated at the server boundary. Unvalidated server
//           functions accept arbitrary client input — this is the
//           primary injection vector for bad data reaching the
//           database or business logic.
//
// Applies:  All src/** files that contain createServerFn calls.
//           Excludes test files and scripts.
//
// Error:    "createServerFn chains .handler() without .validator().
//            Add .validator(schema) before .handler() to validate
//            input at the server boundary."
//
// ── Adapt ─────────────────────────────────────────────────────────────
//
// 1. Server function factory name:
//    If your framework uses a different factory name, replace
//    `createServerFn` with the correct identifier.
//    Examples:
//      createServerFn     — TanStack Start (this template)
//      createServerAction — alternative naming
//
// 2. Validator method name:
//    If your framework uses a different validation chaining method,
//    update the negative lookahead check in the regex.
//    Examples:
//      .validator(       — TanStack Start v1 (this template)
//      .inputValidator(  — TanStack Start alternative
//      .input(           — tRPC-style
//      .schema(          — alternative validation naming
//
// 3. No-input server functions:
//    The default pattern excludes no-input server functions
//    (those with empty parentheses: `createServerFn().handler(fn)`)
//    using the `! $args <: .` guard. This means server functions
//    that take no input (e.g., "get current session") will NOT
//    trigger this rule, which is the correct behavior since they
//    have nothing to validate.
//
//    If you want stricter enforcement that requires ALL server
//    functions to have .validator() regardless of input, remove
//    the `! $args <: .` line from the pattern below.
//
// ──────────────────────────────────────────────────────────────────────

file(name=$filename, body=$program) where {
    // --- Global exclusions (shared across all rules) ---
    ! $filename <: r".*\.test\.[tj]sx?$|.*\.integration\.test\.[tj]sx?$|.*__tests__.*|.*src/test/.*",
    ! $filename <: r".*/scripts/.*",

    $program <: contains bubble `createServerFn($args).handler($handler)` as $chain where {
        // Exclude no-input server functions (empty parentheses).
        // GritQL's $args metavariable matches even when there are zero
        // arguments. The `.` (dot) matches an empty/absent node — negating
        // it means "args must be non-empty."
        ! $args <: .,
        register_diagnostic(
            span = $chain,
            message = "createServerFn chains .handler() without .validator(). Add .validator(schema) before .handler() to validate input at the server boundary."
        )
    }
}

// ── How this works ───────────────────────────────────────────────────
//
// The pattern `createServerFn($args).handler($handler)` matches
// ONLY when .handler() is chained directly to createServerFn()
// with no intermediate method call. When .validator() (or any
// other method) is chained between them, the AST structure
// becomes createServerFn($args).validator($schema).handler($handler),
// which does NOT match the two-call chain pattern.
//
// The `! $args <: .` guard excludes the empty-args case. GritQL's
// $args metavariable matches even when there are zero arguments,
// so without this guard, `createServerFn().handler(fn)` would
// false-positive. The `.` (dot) matches an empty/absent node —
// negating it means "args must be non-empty."
//
// This means:
//   createServerFn({ method: "POST" }).handler(fn)              — MATCHES (violation)
//   createServerFn({ method: "POST" }).validator(z).handler(fn) — no match (valid)
//   createServerFn().handler(fn)                                — no match (no input to validate)
